<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>-</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
  </style>
</head>
<body>
<h1 id="práctica-2-domesticación-de-aplicaciones-y-federación-propuesta-lcms">Práctica 2: domesticación de aplicaciones y federación (propuesta LCMS)</h1>
<h2 id="inteligencia-de-negocio">Inteligencia de Negocio</h2>
<h2 id="autora-almudena-garcía-jurado-centurión">Autora: Almudena García Jurado-Centurión</h2>
<h2 id="enunciado">Enunciado</h2>
<h3 id="introducción">Introducción</h3>
<p>Ante la creciente demanda de máster interuniversitarios virtuales, algunas universidades públicas andaluzas han propuesto la creación de la plataforma denominada campusvirtual. El objetivo de esta plataforma es que, en la medida de lo posible, se centralice la gestión y administración de dichos másters. Esto es, la matriculación se realiza en cada una de las universidades pero la docencia virtual se distribuye entre cada una de ellas.</p>
<p>La solución propuesta se basa en el uso de Moodle como gestor de contenidos y SimpleSAMLphp como software para desarrollar la parte de autentificación y provisión de usuarios.</p>
<p>Cada universidad deberá desplegar su propio gestor de contenidos y su servicio de provisión de identidad. En el gestor de contenidos se albergará las asignaturas que la universidad coordina, se detalla en el apartado siguiente. El IdP tendrá que autentificar los usuarios de la propia universidad y delegar la autentificación de usuarios externos en los IdP del resto de universidades.</p>
<h3 id="caso-de-estudio">Caso de estudio</h3>
<p>Este año, y como propuesta piloto, se ha seleccionado el Máster de Economía y Finanzas impartido por 4 universidades. El plan docente es el que se indica a continuación:</p>
<p>La primera columna de la tabla muestra el identificador que usaremos a lo largo del presente documento para referirnos a las asignaturas. La segunda columna indica el nombre de la asignatura mientras que la tercera contiene el acrónimo de la universidad encargada de impartir la docencia. Esta universidad será la responsable de proporcionar los recursos necesarios para el seguimiento virtual de la asignatura (una instancia de Moodle y un IdP capaz de autentificar a usuarios remotos).</p>
<p>De forma análoga a la impartición de la docencia, las gestión relacionada con la matriculación y desmatriculación de alumnos se hace en las secretarías de cada una de las universidades. Así, por ejemplo, los alumnos de la UHU se tendrán que dirigir a la secretaría de su centro para formalizar la matrícula en cualquiera de las asignaturas que conforman el plan de estudios, independientemente de si la asignatura es impartida por la UHU u otra universidad. Esta gestión local implica que cada universidad usa sus propios códigos para identificar las asignaturas:</p>
<h3 id="atributos-a-intercambiar">Atributos a intercambiar</h3>
<p>A forma de resumen, los atributos que obligatoriamente deben intercambiar los IdP de cada una de las universidades:</p>
<ul>
<li>Personales: gn, cn, sn, schacSn1, displayName</li>
<li>Contacto/localizacion: irisMailMainAddress</li>
<li>Académicos/laborales: eduPersonScopedAffiliation, eduPersonAffiliation, eduPersonPrimaryAffiliation</li>
<li>Gestión: eduPersonPrincipalName, schacPersonalUniqueID, schacUserStatu</li>
</ul>
<p>En http://confia.aupa.info/media/docs/especificacion_atributos.pdf se puede consultar el detalle de todos y cada uno de estos atributos</p>
<h3 id="pasos">Pasos</h3>
<p>Una vez que el alumno ha elegido dos universidades, se le propone que siga los siguientes pasos para cada una de ellas:</p>
<ol type="1">
<li>Cree y configure una instancia de SimpleSAMLphp en modo IdP</li>
<li>Como fuente de autentificación se usará una de tipo sqlauth:SQL. Esto es, cada universidad realizará la autentificación y provisión del sus alumnos a partir de una base de datos sql.</li>
<li>Instale un servidor mysql (se propone usar el contenedor oficial de mariadb https://hub.docker.com/_/mariadb)</li>
<li>Una vez instalado, importe el esquema de base de datos de la universidad elegida</li>
<li>Compruebe que la fuente de autentificación funciona correctamente</li>
<li>Cree y configure una instancia de SimpleSAMLphp en modo SP</li>
<li>Establezca la relación de confianza entre el SP y el IdP para que el SP pueda usar el IdP como fuente de autentificación</li>
<li>Instale moodle (https://hub.docker.com/r/jauer/moodle/) y cree las asignaturas de las que es responsable la universidad</li>
<li>Instale el módulo que permite la autentificación de usuarios usando SimpleSAML (https://moodle.org/plugins/auth_saml). Configúrelo adecuadamente y compruebe que pueden acceder los alumnos de la universidad que están matriculados en alguna de la asignaturas de la que la universidad es responsable. Además compruebe en el perfil de los alumnos de moodle que se importan adecuadamente los atributos liberados por el IdP</li>
<li>Instale el módulo que permite la matriculación automática (https://moodle.org/plugins/view.php?plugin=enrol_saml) de alumos a partir de los datos contenidos en el atributo shacUserStatus devuelto por el IdP. Configúrelo adecuadamente para que la matriculación y desmatriculación de alumnos sea automática una ve que acceden a moodle</li>
</ol>
<p>Una vez hecho todo esto, deberá conseguir que el IdP de una universidad dé la posibilidad de delegar la autentificación en el IdP de la otra universidad para autentificar a los usuarios de esta última.</p>
<h2 id="resolución">Resolución</h2>
<h3 id="instalación-de-simplesaml">Instalación de SimpleSAML</h3>
<p>Para instalar SimpleSAML, utilizaremos una imagen de Docker, que desplegaremos en un contenedor. La imagen a utilizar será la unicon/simplesamlphp:latest (la última versión), y la desplegaremos con el comando:</p>
<pre><code>sudo docker run --name simplesamlphp -p 8081:80 -p 8444:443 -d unicon/simplesamlphp:latest</code></pre>
<p>Esto creará un contenedor de nombre <code>simplesamlphp</code>, redireccionando varios de sus puertos al sistema anfitrión:</p>
<ul>
<li>http: Redireccionamos el puerto 80 del contenedor al 8081 del anfitrión (el puerto 8080 ya estaba reservado)</li>
<li>https: Redireccionamos el puerto 443 al 8444 (el 8443 estaba reservado)</li>
</ul>
<p>Una vez arrancado el contenedor, entramos en la dirección</p>
<p>https://localhost:8444/simplesaml</p>
<p><img src="imagenes/Screenshot_2021-07-08%20Página%20de%20instalación%20de%20SimpleSAMLphp.png" /></p>
<p>Comprobamos que ha arrancado correctamente</p>
<h4 id="configuración-de-simplesaml">Configuración de SimpleSAML</h4>
<p>Una vez comprobamos que la página carga correctamente, accedemos al contenedor para editar algunos ajustes. Editaremos los ajustes básicos, que luego empaquetaremos en forma de imagen base para crear las dos instancias</p>
<pre><code>sudo docker exec -it simplesamlphp bash</code></pre>
<p>Esto nos abrirá una terminal dentro del contenedor</p>
<pre><code>[sudo] password for almu: 
[root@6dfc2f5f3f1f /]# </code></pre>
<p>Para facilitar la edición de algunos ficheros, instalamos el editor <code>nano</code></p>
<pre><code>yum install nano</code></pre>
<p>Lo ejecutamos en el contenedor, y veremos algo así. Cuando nos pregunte “Is this ok”, escribimos “y” y pulsamos Enter para instalar el paquete</p>
<pre><code>[root@6dfc2f5f3f1f /]# yum install nano
Loaded plugins: fastestmirror, ovl
Loading mirror speeds from cached hostfile
epel/x86_64/metalink                                     |  34 kB     00:00     
 * base: mirror.airenetworks.es
 * epel: ftp.plusline.net
 * extras: mirror.airenetworks.es
 * remi-php72: mir01.syntis.net
 * remi-safe: mir01.syntis.net
 * updates: mirror.airenetworks.es
base                                                     | 3.6 kB     00:00     
epel                                                     | 4.7 kB     00:00     
extras                                                   | 2.9 kB     00:00     
remi-php72                                               | 3.0 kB     00:00     
remi-safe                                                | 3.0 kB     00:00     
updates                                                  | 2.9 kB     00:00     
(1/9): base/7/x86_64/group_gz                              | 153 kB   00:00     
(2/9): epel/x86_64/group_gz                                |  96 kB   00:00     
(3/9): extras/7/x86_64/primary_db                          | 242 kB   00:00     
(4/9): epel/x86_64/updateinfo                              | 1.0 MB   00:01     
(5/9): remi-php72/primary_db                               | 250 kB   00:01     
(6/9): remi-safe/primary_db                                | 2.0 MB   00:04     
(7/9): base/7/x86_64/primary_db                            | 6.1 MB   00:05     
(8/9): updates/7/x86_64/primary_db                         | 8.8 MB   00:11     
(9/9): epel/x86_64/primary_db                              | 6.9 MB   00:18     
Resolving Dependencies
--&gt; Running transaction check
---&gt; Package nano.x86_64 0:2.3.1-10.el7 will be installed
--&gt; Finished Dependency Resolution

Dependencies Resolved

================================================================================
 Package        Arch             Version                   Repository      Size
================================================================================
Installing:
 nano           x86_64           2.3.1-10.el7              base           440 k

Transaction Summary
================================================================================
Install  1 Package

Total download size: 440 k
Installed size: 1.6 M
Is this ok [y/d/N]: y
Downloading packages:
nano-2.3.1-10.el7.x86_64.rpm                               | 440 kB   00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : nano-2.3.1-10.el7.x86_64                                     1/1 
  Verifying  : nano-2.3.1-10.el7.x86_64                                     1/1 

Installed:
  nano.x86_64 0:2.3.1-10.el7                                                    

Complete!</code></pre>
<h5 id="modificando-la-clave-de-administrador">Modificando la clave de administrador</h5>
<p>Entramos al fichero <code>/var/simplesamlphp/config/config.php</code></p>
<pre><code>nano /var/simplesamlphp/config/config.php</code></pre>
<p>Y editamos el campo <code>auth.adminpassword</code></p>
<pre><code>&#39;auth.adminpassword&#39; =&gt; &#39;admin&#39;</code></pre>
<p>Reemplazamos ‘admin’ por la clave de nuestra preferencia</p>
<h5 id="activando-modo-idp">Activando modo IDP</h5>
<p>En el mismo fichero, activamos el modo IDP editando la variable <code>'enable.saml20-idp'</code></p>
<pre><code>&#39;enable.saml20-idp&#39; =&gt; true,</code></pre>
<h5 id="configurando-modo-sp">Configurando modo SP</h5>
<p>Preparamos algunas configuraciones para el SP. Entramos en <code>/var/simplesamlphp/config/authsources.php</code> y, en el bloque <code>default-sp</code>, modificamos (o las creamos, en caso de no existir) estas líneas:</p>
<p>Preconfiguramos una URL para el <code>entityID</code>, y añadimos el certificado y la clave pública. Esto ayudará a modificar estos valores en las instancias del contenedor</p>
<pre><code>&#39;entityID&#39; =&gt; &#39;https://sp.edu.net/sp&#39;,
//&#39;privatekey&#39; =&gt; &#39;server.key&#39;,
//&#39;certificate&#39; =&gt; &#39;server.pub&#39;,
&#39;idp&#39; =&gt; &#39;https://idp.edu.net/idp&#39;</code></pre>
<p>Dado que las claves deben ser únicas, estas no se generarán todavía. Deberán generarse al crear cada instancia.</p>
<h5 id="añadiendo-fuente-de-autenticación">Añadiendo fuente de autenticación</h5>
<p>Entramos en el fichero <code>/var/simplesamlphp/config/authsources.php</code> y descomentamos el bloque <code>example-sql</code>. También editamos algunos campos para adaptarlos a MySQL</p>
<pre><code>&#39;example-sql&#39; =&gt; [
    &#39;sqlauth:SQL&#39;,
    &#39;dsn&#39; =&gt; &#39;mysql:host=mariadb;port=3306;dbname=simplesaml&#39;,
    &#39;username&#39; =&gt; &#39;simplesaml&#39;,
    &#39;password&#39; =&gt; &#39;secretpassword&#39;,
    &#39;query&#39; =&gt; &#39;SELECT uid, givenName, email, eduPersonPrincipalName FROM users WHERE uid = :username &#39; .
        &#39;AND password = SHA2(CONCAT((SELECT salt FROM users WHERE uid = :username), :password), 256);&#39;,
],</code></pre>
<h5 id="configurando-ruta-de-metadatos-en-el-idp">Configurando ruta de metadatos en el IDP</h5>
<p>Entramos al fichero <code>/var/simplesamlphp/metadata/saml20-idp-hosted</code> y añadimos la información</p>
<p>$metadata[‘https://idp.edu.net/idp’] = array( ‘host’ =&gt; ‘<strong>DEFAULT</strong>’, ‘privatekey’ =&gt; ‘server.key’, ‘certificate’ =&gt; ‘server.crt’, ‘auth’ =&gt; ‘example-sql’, );</p>
<p>Esto servirá de base para las siguientes imágenes. Los certificados, dado que deben ser únicos, se generarán en cada instancia, por lo que no los crearemos ahora.</p>
<p>Como fuente de autenticación indicamos <code>example-sql</code>, correspondiente al ejemplo de uso de <code>sqlauth</code></p>
<h5 id="comprobando">Comprobando</h5>
<p>Al entrar en la pestaña Federación de SimpleSAML vemos que tenemos los modos SP e IDP, y los metadatos del SP.</p>
<p><img src="imagenes/Screenshot_2021-07-08%20Página%20de%20instalación%20de%20SimpleSAMLphp1.png" /></p>
<p>Comprobamos también que podemos iniciar sesión como administrador</p>
<p><img src="imagenes/Screenshot_2021-07-08%20Página%20de%20instalación%20de%20SimpleSAMLphp2.png" /></p>
<h4 id="compilando-la-imagen">Compilando la imagen</h4>
<p>Una vez realizada la configuración básica, creamos una imagen con todas las configuraciones. Nos copiamos el directorio <code>/var/simplesamlphp</code> en el directorio <code>simplesamlbase/simplesamlphp</code>, y nos creamos un Dockerfile con el siguiente contenido</p>
<pre><code>FROM unicon/simplesamlphp:latest 

RUN rm -rf /var/simplesamlphp
COPY ./simplesamlphp/ /var/simplesamlphp/</code></pre>
<p>Hecho esto, compilamos la imagen y la subimos a Docker Hub</p>
<pre><code>sudo docker build . -t simplesamlbase
sudo docker tag simplesamlbase almuhs/simplesamlphp_preconf:v1
sudo docker push almuhs/simplesamlphp_preconf:v1</code></pre>
<h4 id="creando-las-bases-de-datos">Creando las bases de datos</h4>
<p>Tanto SimpleSAML como Moodle requieren de una base de datos para funcionar. Para ahorrar contenedores, utilizaremos el mismo contenedor para ambos.</p>
<p>Para crear la base de datos, nos basaremos en la imagen bitnami/mariadb. Sobre esta imagen, crearemos dos imágenes personalizadas, en las que cargaremos la base de datos de cada universidad. Mas adelante, cuando se despliegue el contenedor, se añadirán los datos de la base de datos de Moodle: una nueva base de datos y un nuevo usuario.</p>
<h5 id="creando-las-imágenes-personalizadas">Creando las imágenes personalizadas</h5>
<p>Para cargar los esquemas de cada universidad, crearemos un directorio sql/ en el mismo directorio del Dockerfile, donde alojaremos el script SQL correspondiente. Posteriormente, en el Dockerfile, añadiremos la siguiente línea para cargar el script en la imagen</p>
<pre><code>ADD sql/ /docker-entrypoint-initdb.d</code></pre>
<p>Sobre esto, crearemos dos imágenes: <code>mariadb_upo</code>, con el esquema de bases de datos de la UPO; y <code>mariadb_uca</code>, con el esquema de bases de datos de la UCA.</p>
<p>En el caso de <code>mariadb_uca</code> también cambiaremos el puerto de MySQL al 3307. Esto permitirá arrancar ambos contenedores de bases de datos sobre la misma red, sin producir solapamiento.</p>
<p>El Dockerfile de <code>mariadb_upo</code> queda así:</p>
<pre><code>FROM bitnami/mariadb

## Modify the ports used by MariaDB by default
# It is also possible to change these environment variables at runtime
# Copy the SQL script from /sql to Docker&#39;s entrypoint
ADD sql/ /docker-entrypoint-initdb.d

ENV MARIADB_PORT_NUMBER=3306
EXPOSE 3306</code></pre>
<p>El Docker de <code>mariadb_uca</code> queda así:</p>
<pre><code>FROM bitnami/mariadb

## Modify the ports used by MariaDB by default
# It is also possible to change these environment variables at runtime
# Copy the SQL script from /sql to Docker&#39;s entrypoint
ADD sql/ /docker-entrypoint-initdb.d

ENV MARIADB_PORT_NUMBER=3307
EXPOSE 3307</code></pre>
<p>Además, en los scripts de la base de datos añadiremos las instrucciones para crear la nueva base de datos y el usuario asociados a las mismas.</p>
<h5 id="creando-el-script-con-el-esquema-de-la-base-de-datos">Creando el script con el esquema de la base de datos</h5>
<p>En el script donde se carga el esquema de la base de datos, añadimos varias instrucciones para crear la base de datos en sí y un nuevo usuario con total permiso sobre las mismas. Esto evitará el tener que crear la base de datos durante el despliegue, pudiendo utilizar el despliegue para crear una segunda base de datos, con los datos de moodle.</p>
<p>En <code>uca.sql</code></p>
<pre><code>DROP DATABASE IF EXISTS uca;
CREATE DATABASE uca;

CREATE USER ucausr IDENTIFIED BY &#39;ucapass&#39;;
GRANT ALL privileges ON uca.* to ucausr;</code></pre>
<p>En <code>upo.sql</code></p>
<pre><code>DROP DATABASE IF EXISTS upo;
CREATE DATABASE upo;

CREATE USER upousr IDENTIFIED BY &#39;upopass&#39;;
GRANT ALL privileges ON upo.* to upousr;</code></pre>
<h5 id="generando-las-imágenes-personalizadas">Generando las imágenes personalizadas</h5>
<p>Finalmente, generamos las imágenes personalizadas y las subimos a Docker Hub.</p>
<p>Para la UPO:</p>
<pre><code>cd upo/
sudo docker build . -t mariadb_upo
sudo docker tag mariadb_upo almuhs/mariadb_upo:v1
sudo docker login
sudo docker push almuhs/mariadb_upo:v1</code></pre>
<p>Para la UCA:</p>
<pre><code>cd uca/
sudo docker build . -t mariadb_uca
sudo docker tag mariadb_uca almuhs/mariadb_uca:v1
sudo docker login
sudo docker push almuhs/mariadb_uca:v1</code></pre>
<h3 id="desplegando-la-infraestructura">Desplegando la infraestructura</h3>
<p>Finalmente, desplegamos la infraestructura con todos los contenedores</p>
<h4 id="docker-compose">Docker Compose</h4>
<p>Nos creamos un fichero Docker Compose por cada universidad. Este fichero desplegará la siguiente infraestructura:</p>
<ul>
<li>Instancia de MariaDB, basada en la imagen personalizada de dicha universidad, en la que se creará una nueva base de datos y usuario para Moodle</li>
<li>Instancia de Moodle, conectada a la instancia de MariaDB
<ul>
<li>Con una conexión al volumen de datos de SimpleSAML</li>
</ul></li>
<li>Instancia de SimpleSAML</li>
<li>Volumen de MariaDB</li>
<li>2 volúmenes para los datos de Moodle</li>
<li>Volumen de SimpleSAML</li>
</ul>
<p>Para los servicios web de SImpleSAML y Moodle, realizaremos un redireccionamiento de puertos, para evitar el solapamiento de los mismos:</p>
<ul>
<li>Moodle UPO:
<ul>
<li>8080 -&gt; 8080</li>
<li>8443 -&gt; 8443</li>
</ul></li>
<li>SimpleSAML UPO
<ul>
<li>8081 -&gt; 80</li>
<li>8444 -&gt; 443</li>
</ul></li>
<li>Moodle UCA
<ul>
<li>8082 -&gt; 8080</li>
<li>8445 -&gt; 8443</li>
</ul></li>
<li>SimpleSAML UCA
<ul>
<li>8083 -&gt; 80</li>
<li>8446 -&gt; 443</li>
</ul></li>
</ul>
<p>Además, el contenedor MariaDB de la UCA utilizará el puerto 3307 en lugar del 3306</p>
<h4 id="desplegando-los-contenedores">Desplegando los contenedores</h4>
<p>Para desplegar los contenedores, nos situamos en el directorio de cada universidad, y levantamos la infraestructura con docker-compose</p>
<pre><code>cd upo/
sudo docker-compose up -d

cd uca/
sudo docker-compose up -d</code></pre>
<p>Si todo ha ido bien, veremos algo como esto</p>
<pre><code>almu@debian:~/Practicas_IN/Practica2/uca$ sudo docker-compose up -d
Creating network &quot;uca_default&quot; with the default driver
Creating volume &quot;uca_mariadb_data_uca&quot; with local driver
Creating volume &quot;uca_moodle_data_uca&quot; with local driver
Creating volume &quot;uca_moodledata_data_uca&quot; with local driver
Creating volume &quot;uca_simplesamlphp_data_uca&quot; with local driver
Creating uca_mariadb_uca_1       ... done
Creating uca_simplesamlphp_uca_1 ... done
Creating uca_moodle_uca_1        ... done
almu@debian:~/Practicas_IN/Practica2/uca$ cd ../upo
almu@debian:~/Practicas_IN/Practica2/upo$ sudo docker-compose up -d
Creating network &quot;upo_default&quot; with the default driver
Creating volume &quot;upo_mariadb_data_upo&quot; with local driver
Creating volume &quot;upo_moodle_data_upo&quot; with local driver
Creating volume &quot;upo_moodledata_data_upo&quot; with local driver
Creating volume &quot;upo_simplesamlphp_data_upo&quot; with local driver
Creating upo_simplesamlphp_upo_1 ... done
Creating upo_mariadb_upo_1       ... done
Creating upo_moodle_upo_1        ... done
almu@debian:~/Practicas_IN/Practica2/upo$ sudo docker ps
CONTAINER ID   IMAGE                         COMMAND                  CREATED          STATUS          PORTS                                            NAMES
c48a7aa12235   bitnami/moodle:3              &quot;/opt/bitnami/script…&quot;   4 seconds ago    Up 3 seconds    0.0.0.0:8080-&gt;8080/tcp, 0.0.0.0:8443-&gt;8443/tcp   upo_moodle_upo_1
8d6d59df8197   unicon/simplesamlphp:latest   &quot;httpd-foreground&quot;       5 seconds ago    Up 3 seconds    0.0.0.0:8081-&gt;80/tcp, 0.0.0.0:8444-&gt;443/tcp      upo_simplesamlphp_upo_1
68db04909b52   almuhs/mariadb_upo:v1         &quot;/opt/bitnami/script…&quot;   5 seconds ago    Up 4 seconds    3306/tcp                                         upo_mariadb_upo_1
422b67be0148   bitnami/moodle:3              &quot;/opt/bitnami/script…&quot;   31 seconds ago   Up 30 seconds   0.0.0.0:8082-&gt;8080/tcp, 0.0.0.0:8445-&gt;8443/tcp   uca_moodle_uca_1
fa6e241ed4af   almuhs/mariadb_uca:v1         &quot;/opt/bitnami/script…&quot;   32 seconds ago   Up 31 seconds   3306/tcp, 0.0.0.0:49155-&gt;3307/tcp                uca_mariadb_uca_1
f1651014342e   unicon/simplesamlphp:latest   &quot;httpd-foreground&quot;       32 seconds ago   Up 31 seconds   0.0.0.0:8083-&gt;80/tcp, 0.0.0.0:8446-&gt;443/tcp      uca_simplesamlphp_uca_1
almu@debian:~/Practicas_IN/Practica2/upo$ </code></pre>
<p>Los contenedores de Moodle tardarán varios minutos en desplegarse. Podemos ver el progreso del arranque con <code>docker logs</code></p>
<pre><code>sudo docker logs upo_moodle_upo_1
sudo docker logs uca_moodle_uca_1</code></pre>
<p>Cuando termine el despliegue, veremos algo como esto</p>
<pre><code>almu@debian:~/Practicas_IN/Practica2/upo$ sudo docker logs uca_moodle_uca_1
moodle 14:38:06.23 
moodle 14:38:06.23 Welcome to the Bitnami moodle container
moodle 14:38:06.23 Subscribe to project updates by watching https://github.com/bitnami/bitnami-docker-moodle
moodle 14:38:06.23 Submit issues and feature requests at https://github.com/bitnami/bitnami-docker-moodle/issues
moodle 14:38:06.23 
moodle 14:38:06.23 INFO  ==&gt; ** Starting Moodle setup **
moodle 14:38:06.29 INFO  ==&gt; Configuring PHP options
moodle 14:38:06.31 INFO  ==&gt; Validating settings in MYSQL_CLIENT_* env vars
moodle 14:38:06.41 INFO  ==&gt; Ensuring Moodle directories exist
moodle 14:38:06.43 INFO  ==&gt; Trying to connect to the database server
moodle 14:38:21.48 INFO  ==&gt; Running Moodle install script
moodle 14:41:52.87 INFO  ==&gt; Persisting Moodle installation
moodle 14:41:58.29 INFO  ==&gt; ** Moodle setup finished! **

moodle 14:41:58.30 INFO  ==&gt; ** Starting cron **
moodle 14:41:58.33 INFO  ==&gt; ** Starting Apache **
[Fri Jul 09 14:41:58.400649 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:41:58.401247 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:41:58.448053 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:41:58.448590 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:41:58.466070 2021] [mpm_prefork:notice] [pid 1] AH00163: Apache/2.4.48 (Unix) OpenSSL/1.1.1d PHP/7.3.29 configured -- resuming normal operations
[Fri Jul 09 14:41:58.466110 2021] [core:notice] [pid 1] AH00094: Command line: &#39;/opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND&#39;

almu@debian:~/Practicas_IN/Practica2/upo$ sudo docker logs upo_moodle_upo_1
moodle 14:38:33.66 
moodle 14:38:33.66 Welcome to the Bitnami moodle container
moodle 14:38:33.66 Subscribe to project updates by watching https://github.com/bitnami/bitnami-docker-moodle
moodle 14:38:33.66 Submit issues and feature requests at https://github.com/bitnami/bitnami-docker-moodle/issues
moodle 14:38:33.66 
moodle 14:38:33.66 INFO  ==&gt; ** Starting Moodle setup **
moodle 14:38:33.73 INFO  ==&gt; Configuring PHP options
moodle 14:38:33.75 INFO  ==&gt; Validating settings in MYSQL_CLIENT_* env vars
moodle 14:38:33.85 INFO  ==&gt; Ensuring Moodle directories exist
moodle 14:38:33.87 INFO  ==&gt; Trying to connect to the database server
moodle 14:38:48.91 INFO  ==&gt; Running Moodle install script
moodle 14:42:19.75 INFO  ==&gt; Persisting Moodle installation
moodle 14:42:25.09 INFO  ==&gt; ** Moodle setup finished! **

moodle 14:42:25.10 INFO  ==&gt; ** Starting cron **
moodle 14:42:25.12 INFO  ==&gt; ** Starting Apache **
[Fri Jul 09 14:42:25.175024 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:42:25.175465 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:42:25.207388 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:42:25.207840 2021] [ssl:warn] [pid 1] AH01909: www.example.com:8443:0 server certificate does NOT include an ID which matches the server name
[Fri Jul 09 14:42:25.225081 2021] [mpm_prefork:notice] [pid 1] AH00163: Apache/2.4.48 (Unix) OpenSSL/1.1.1d PHP/7.3.29 configured -- resuming normal operations
[Fri Jul 09 14:42:25.225114 2021] [core:notice] [pid 1] AH00094: Command line: &#39;/opt/bitnami/apache/bin/httpd -f /opt/bitnami/apache/conf/httpd.conf -D FOREGROUND&#39;</code></pre>
<h4 id="probando-la-infraestructura">Probando la infraestructura</h4>
<p>Para probar la infraestructura, entramos a las URL de los diferentes servicios web</p>
<ul>
<li>Moodle UPO:
<ul>
<li>http://localhost:8080/</li>
<li>https://localhost:8443/</li>
</ul></li>
<li>SimpleSAML UPO
<ul>
<li>http://localhost:8081/simplesaml</li>
<li>https://localhost:8444/simplesaml</li>
</ul></li>
<li>Moodle UCA
<ul>
<li>http://localhost:8082/</li>
<li>https://localhost:8445/</li>
</ul></li>
<li>SimpleSAML UCA
<ul>
<li>http://localhost:8083/simplesaml/</li>
<li>https://localhost:8446/simplesaml/</li>
</ul></li>
</ul>
<h3 id="configurando-las-instancias-de-simplesaml">Configurando las instancias de SimpleSAML</h3>
<p>Con la infraestructura básica preparada, pasamos a configurar las instancias de SimpleSAML.</p>
<h4 id="simplesaml-upo">SimpleSAML UPO</h4>
<h5 id="fuentes-de-autenticación">Fuentes de autenticación</h5>
<p>Entramos en el fichero <code>/var/simplesamlphp/config/authsources.php</code> y editamos las fuentes <code>default-sp</code> y <code>example-sql</code>.</p>
<pre><code>&#39;default-sp&#39; =&gt; [
        &#39;saml:SP&#39;,

        // The entity ID of this SP.
        // Can be NULL/unset, in which case an entity ID is generated based on the metadata URL.
        &#39;entityID&#39; =&gt; null,
        &#39;privatekey&#39; =&gt; &#39;server.key&#39;,
        &#39;certificate&#39; =&gt; &#39;server.pub&#39;,
        // The entity ID of the IdP this SP should contact.
        // Can be NULL/unset, in which case the user will be shown a list of available IdPs.
        &#39;idp&#39; =&gt; &#39;https://idp.upo.net/idp&#39;,
        
        ...</code></pre>
<p>En example-sql, añadimos los datos de conexión de la base de datos, y la consulta a la misma</p>
<pre><code>&#39;example-sql&#39; =&gt; [
        &#39;sqlauth:SQL&#39;,
        &#39;dsn&#39; =&gt; &#39;mysql:host=mariadb_upo;port=3306;dbname=upo&#39;,
        &#39;username&#39; =&gt; &#39;upousr&#39;,
        &#39;password&#39; =&gt; &#39;upopass&#39;,
        &#39;query&#39; =&gt; &#39;SELECT nombre As gn,
                        CONCAT(nombre,&quot; &quot;,ape1, &quot; &quot;,ape2) As cn,
                        CONCAT(ape1, &quot; &quot;, ape2) As sn,
                        ape1 As schacSn1,
                        identificador As displayName,
                        correo As irisMailMainAddress,
                        &quot;student@upo.es&quot; as eduPersonScopedAffiliation,
                        &quot;student&quot; As  eduPersonAffiliation,
                        &quot;student&quot; As eduPersonPrimaryAffiliation,
                        CONCAT(:username,&quot;@upo.es&quot;) As eduPersonPrincipalName, 
                        CONCAT(&quot;urn:mace:upo.es:schac:personalUniqueID:es:NIF:&quot;,dni) As schacPersonalUniqueID,
                        CONCAT(&quot;urn:mace:terena.org:schac:userStatus:es:upo.es:&quot;, asignaturas.cod, &quot;:2021-22:student:active&quot;) as schacUserStatus
                        FROM upo.alumnos, upo.asignaturas, upo.matriculados
                        WHERE matriculados.id_alumno = alumnos.id
                              AND alumnos.identificador=:username
                              AND password=:password&#39;,
    ],</code></pre>
<h5 id="certificados-del-sp">Certificados del SP</h5>
<p>Creamos los certificados para <code>default-sp</code>. Para ello, utilizamos la <a href="https://www.samltool.com/self_signed_certs.php">herramienta de creación de certificados de SAMLTool</a></p>
<p>Rellenamos los datos</p>
<p><img src="imagenes/Screenshot_2021-07-09%20Generate%20SAML%20Self-Signed%20X%20509%20Certificates%20-%20Create%20Self%20Signed%20Certs%20SAMLTool%20com.png" /></p>
<p>Y pulsamos en “Generate self-signed certs”</p>
<p><img src="imagenes/Screenshot_2021-07-09%20Generate%20SAML%20Self-Signed%20X%20509%20Certificates%20-%20Create%20Self%20Signed%20Certs%20SAMLTool%20com(1).png" /></p>
<p>Copiamos el contenido de private-key en <code>/var/simplesamlphp/cert/server.key</code>, y el de X.509 cert en <code>/var/simplesamlphp/cert/server.pub</code>.</p>
<h5 id="par-de-claves-del-idp">Par de claves del IDP</h5>
<p>Generamos el par de claves del IDP</p>
<pre><code>cd /var/simplesamlphp/cert
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/pki/tls/private/server.key -out /etc/pki/tls/certs/server.crt</code></pre>
<h5 id="metadatos-del-idp">Metadatos del IDP</h5>
<p>Corregimos el nombre de dominio en los metadatos del IDP</p>
<pre><code>nano /var/simplesamlphp/metadata/saml20-idp-hosted.php</code></pre>
<p>Y editamos los metadatos de esta manera:</p>
<pre><code>$metadata[&#39;https://idp.upo.net/idp&#39;] = array(
        &#39;host&#39; =&gt; &#39;__DEFAULT__&#39;,
        &#39;privatekey&#39; =&gt; &#39;server.key&#39;,
        &#39;certificate&#39; =&gt; &#39;server.pub&#39;,
        &#39;auth&#39; =&gt; &#39;example-sql&#39;,
);</code></pre>
<p>Comprobamos que los metadatos se han generado correctamente</p>
<p><img src="imagenes/Screenshot_2021-07-09%20Metadatos%20IdP%20SAML%202%200.png" /></p>
<h5 id="probando-el-idp">Probando el IDP</h5>
<p>En la interfaz web de SimpleSAML pulsamos en “Probar las fuentes para la autentificación ya configuradas”</p>
<p><img src="imagenes/Screenshot_2021-07-09%20Página%20de%20instalación%20de%20SimpleSAMLphp.png" /></p>
<p>Vemos que aparece el “example-sql” en la lista</p>
<p><img src="imagenes/Screenshot_2021-07-09%20Test%20authentication%20sources.png" /></p>
<p>Al pulsar sobre él, vemos una pantalla de login</p>
<p><img src="imagenes/Screenshot_2021-07-09%20Introduzca%20su%20nombre%20de%20usuario%20y%20contraseña.png" /></p>
<h5 id="probando-el-inicio-de-sesión">Probando el inicio de sesión</h5>
<p>Probamos el inicio de sesión. Entramos en <code>example-sql</code> desde la interfaz de SimpleSAML, e introducimos un nombre de usuario y una contraseña</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Introduzca%20su%20nombre%20de%20usuario%20y%20contraseña(2).png" /></p>
<p>En este caso, puesto que no tenemos ningún usuario registrado, nos dará un error</p>
<h4 id="simplesaml-uca">SimpleSAML UCA</h4>
<p>Repetimos el proceso en la instancia de la otra universidad</p>
<h5 id="fuentes-de-autenticación-1">Fuentes de autenticación</h5>
<p>Entramos en el fichero <code>/var/simplesamlphp/config/authsources.php</code> y editamos las fuentes <code>default-sp</code> y <code>example-sql</code>.</p>
<pre><code>&#39;default-sp&#39; =&gt; [
        &#39;saml:SP&#39;,

        // The entity ID of this SP.
        // Can be NULL/unset, in which case an entity ID is generated based on the metadata URL.
        &#39;entityID&#39; =&gt; null,
        &#39;privatekey&#39; =&gt; &#39;server.key&#39;,
        &#39;certificate&#39; =&gt; &#39;server.pub&#39;,
        // The entity ID of the IdP this SP should contact.
        // Can be NULL/unset, in which case the user will be shown a list of available IdPs.
        &#39;idp&#39; =&gt; &#39;https://idp.uca.net/idp&#39;,
        
        ...</code></pre>
<p>En example-sql, añadimos los datos de conexión de la base de datos, y la consulta a la misma</p>
<pre><code>&#39;example-sql&#39; =&gt; [
        &#39;sqlauth:SQL&#39;,
        &#39;dsn&#39; =&gt; &#39;mysql:host=mariadb_uca;port=3307;dbname=uca&#39;,
        &#39;username&#39; =&gt; &#39;ucausr&#39;,
        &#39;password&#39; =&gt; &#39;ucapass&#39;,
        &#39;query&#39; =&gt; &#39;SELECT nombre As gn,
                        CONCAT(nombre,&quot; &quot;,apellidos) As cn,
                        apellidos As sn,
                        apellidos As schacSn1,
                        alumnos.cod As displayName,
                        correo As irisMailMainAddress,
                        &quot;student@uca.es&quot; as eduPersonScopedAffiliation,
                        &quot;student&quot; As  eduPersonAffiliation,
                        &quot;student&quot; As eduPersonPrimaryAffiliation,
                        CONCAT(:username, &quot;@uca.es&quot;) As eduPersonPrincipalName,
                        CONCAT(&quot;urn:mace:upo.es:schac:personalUniqueID:es:NIF:&quot;,CONCAT(dni, letra) ) As schacPersonalUniqueID,
                        CONCAT(&quot;urn:mace:terena.org:schac:userStatus:es:uca.es:&quot;, asignaturas.cod, &quot;:2021-22:student:active&quot;) as schacUserStatus
                        FROM uca.alumnos, uca.asignaturas, uca.matriculados
                        WHERE matriculados.id_alumno = alumnos.id
                              AND alumnos.cod=:username
                              AND password=:password&#39;,
    ],</code></pre>
<h5 id="certificados-del-sp-1">Certificados del SP</h5>
<p><img src="imagenes/Screenshot_2021-07-10%20Generate%20SAML%20Self-Signed%20X%20509%20Certificates%20-%20Create%20Self%20Signed%20Certs%20SAMLTool%20com.png" /></p>
<h5 id="metadatos-del-idp-1">Metadatos del IDP</h5>
<p>Corregimos el nombre de dominio en los metadatos del IDP</p>
<pre><code>nano /var/simplesamlphp/metadata/saml20-idp-hosted.php</code></pre>
<p>Y editamos los metadatos de esta manera:</p>
<pre><code>$metadata[&#39;https://idp.uca.net/idp&#39;] = array(
        &#39;host&#39; =&gt; &#39;__DEFAULT__&#39;,
        &#39;privatekey&#39; =&gt; &#39;server.key&#39;,
        &#39;certificate&#39; =&gt; &#39;server.pub&#39;,
        &#39;auth&#39; =&gt; &#39;example-sql&#39;,
);</code></pre>
<p>Comprobamos que los metadatos se han generado correctamente</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Página%20de%20instalación%20de%20SimpleSAMLphp.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20Metadatos%20IdP%20SAML%202%200.png" /></p>
<h4 id="probando-el-inicio-de-sesión-1">Probando el inicio de sesión</h4>
<h5 id="añadiendo-usuarios-a-la-base-de-datos">Añadiendo usuarios a la base de datos</h5>
<p>Añadimos varios usuarios a la base de datos. Nos conectamos a la base de datos con el comando</p>
<pre><code>sudo docker exec -it uca_mariadb_uca_1 mysql -u &#39;ucausr&#39; -p</code></pre>
<p>E insertamos los usuarios</p>
<pre><code>use uca;
INSERT INTO uca.alumnos(cod, nombre, apellidos, password, dni, letra, correo)
    VALUES(&#39;juan.perez&#39;, &#39;Juan&#39;, &#39;Perez Martin&#39;, &#39;user1&#39;, &#39;56128914&#39;, &#39;K&#39;, &#39;juan.perez@uca.es&#39;);

INSERT INTO uca.alumnos(cod, nombre, apellidos, password, dni, letra, correo)
    VALUES(&#39;alvaro.gomez&#39;, &#39;Alvaro&#39;, &#39;Gomez Martin&#39;, &#39;user2&#39; , &#39;23081274&#39;, &#39;L&#39;, &#39;alvaro.gomez@u.es&#39;);
    
INSERT INTO uca.matriculados(id_alumno, status) VALUES (1, &#39;a&#39;);
INSERT INTO uca.matriculados(id_alumno, status) VALUES (2, &#39;a&#39;);</code></pre>
<h5 id="autenticando-usuarios">Autenticando usuarios</h5>
<p>En la interfaz de SimpleSAML, entramos en “example-sql”, e introducimos los datos de nuestro usuario</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Introduzca%20su%20nombre%20de%20usuario%20y%20contraseña(2)_newuser.png" /></p>
<p>Vemos que el usuario es autenticado correctamente</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Ejemplo%20de%20SAML%202%200%20SP.png" /></p>
<h3 id="uniendo-el-sp-al-idp-y-viceversa">Uniendo el SP al IDP (y viceversa)</h3>
<p>Para unir cada SP con su ISP, hemos de compartir los metadatos entre ambas caras. En la interfaz de SimpleSAMLPHP accedemos a la pestaña de Federación para obtener los metadatos de ambos.</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Página%20de%20instalación%20de%20SimpleSAMLphp2.png" /></p>
<p>En esta veremos los metadatos de ambos. Para establecer la relación de confianza, debemos compartir los metadatos entre ellos.</p>
<h4 id="compartiendo-metadatos-del-idp-al-sp">Compartiendo metadatos del IDP al SP</h4>
<p>En la pestaña Federación, en Metadatos IdP SAML 2.0, pulsamos sobre “Ver metadatos.”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Metadatos%20IdP%20SAML%202%200_idp.png" /></p>
<p>Copiamos los metadatos del bloque de abajo, en formato PHP, y los pegamos en el fichero <code>metadata/saml20-idp-remote.php</code></p>
<h4 id="compartiendo-metadatos-del-sp-al-idp">Compartiendo metadatos del SP al IDP</h4>
<p>Repetimos el proceso, pero esta vez en sentido inverso. En la pestaña Federación, en Metadatos SP SAML 2.0, pulsamos sobre “Ver metadatos”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Metadatos%20SP%20SAML%202%200(1).png" /></p>
<p>Copiamos los metadatos en formato PHP en el fichero <code>metadata/saml20-sp-remote.php</code></p>
<h4 id="comprobando-el-acceso">Comprobando el acceso</h4>
<p>En la pestaña Autenticación, pulsamos en “Probar las fuentes para la autentificación ya configuradas”, y luego seleccionamos “default-sp”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Seleccione%20su%20proveedor%20de%20identidad(1).png" /></p>
<p>Vemos que el SP ya es capaz de detectar correctamente al IDP. Repetimos el proceso con la otra universidad</p>
<h3 id="comunicando-ambas-universidades">Comunicando ambas universidades</h3>
<h4 id="compartiendo-metadatos">Compartiendo metadatos</h4>
<p>Repetimos el proceso que hicimos en el paso anterior, compartiendo los metadatos de los SP e IDP entre las universidades.</p>
<p>Los Metadatos SP SAML 2.0 los copiamos en el fichero <code>metadata/saml20-sp-remote.php</code> de la otra universidad. Los Metadatos IDP SAML 2.0 los copiamos en el fichero <code>metadata/saml20-idp-remote.php</code> de la otra universidad.</p>
<h4 id="comprobando-el-acceso-1">Comprobando el acceso</h4>
<p><img src="imagenes/Captura%20de%20pantalla%20de%202021-07-10%2004-16-13.png" /></p>
<p>Esta vez, cuando pulsamos en “default-sp”, se nos ofrecen los IDP de ambas universidades. Si seleccionamos el IDP de la otra universidad, SimpleSAML nos redirigirá a su plataforma.</p>
<h3 id="configurando-moodle">Configurando Moodle</h3>
<p>Arrancamos Moodle e iniciamos sesión</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Dashboard.png" /></p>
<h4 id="creando-las-asignaturas">Creando las asignaturas</h4>
<p>Con Moodle ya preparado, pasamos a crear las asignaturas en la instancia de cada universidad.</p>
<table>
<thead>
<tr class="header">
<th>#</th>
<th>Nombre</th>
<th>Universidad Responsable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>Programación I</td>
<td>UHU</td>
</tr>
<tr class="even">
<td>2</td>
<td>SISTEMAS DE ALMACENAMIENTO DE LA INFORMACIÓN</td>
<td>UHU</td>
</tr>
<tr class="odd">
<td>3</td>
<td>FUNDAMENTOS DE MATEMÁTICAS</td>
<td>UHU</td>
</tr>
<tr class="even">
<td>4</td>
<td>MODELOS PREDICTIVOS I</td>
<td>US</td>
</tr>
<tr class="odd">
<td>5</td>
<td>MINERÍA DE DATOS I</td>
<td>US</td>
</tr>
<tr class="even">
<td>6</td>
<td>TÉCNICAS DE OPTIMIZACIÓN</td>
<td>US</td>
</tr>
<tr class="odd">
<td>7</td>
<td>MODELOS PREDICTIVOS II</td>
<td>UPO</td>
</tr>
<tr class="even">
<td>8</td>
<td>MINERÍA DE DATOS II</td>
<td>UPO</td>
</tr>
<tr class="odd">
<td>9</td>
<td>INSTRUMENTOS Y DERIVADOS</td>
<td>UPO</td>
</tr>
<tr class="even">
<td>10</td>
<td>FINANZAS INTERNACIONALES</td>
<td>UCA</td>
</tr>
<tr class="odd">
<td>11</td>
<td>GESTIÓN DEL RIESGO Y ASEGURAMIENTO</td>
<td>UCA</td>
</tr>
<tr class="even">
<td>12</td>
<td>FINANZAS COMPUTATIVAS</td>
<td>UCA</td>
</tr>
</tbody>
</table>
<p>En nuestro caso, puesto que solo implementamos para la UPO y la UCA, las asignaturas que nos corresponden son:</p>
<table>
<thead>
<tr class="header">
<th>#</th>
<th>Nombre</th>
<th>Universidad Responsable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>7</td>
<td>MODELOS PREDICTIVOS II</td>
<td>UPO</td>
</tr>
<tr class="even">
<td>8</td>
<td>MINERÍA DE DATOS II</td>
<td>UPO</td>
</tr>
<tr class="odd">
<td>9</td>
<td>INSTRUMENTOS Y DERIVADOS</td>
<td>UPO</td>
</tr>
<tr class="even">
<td>10</td>
<td>FINANZAS INTERNACIONALES</td>
<td>UCA</td>
</tr>
<tr class="odd">
<td>11</td>
<td>GESTIÓN DEL RIESGO Y ASEGURAMIENTO</td>
<td>UCA</td>
</tr>
<tr class="even">
<td>12</td>
<td>FINANZAS COMPUTATIVAS</td>
<td>UCA</td>
</tr>
</tbody>
</table>
<p>Estas asignaturas se corresponden con los siguientes códigos</p>
<table>
<thead>
<tr class="header">
<th>#</th>
<th>UPO</th>
<th>UCA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>7</td>
<td>5021336</td>
<td>5021336</td>
</tr>
<tr class="even">
<td>8</td>
<td>5021337</td>
<td>5021337</td>
</tr>
<tr class="odd">
<td>9</td>
<td>5021338</td>
<td>5021338</td>
</tr>
<tr class="even">
<td>10</td>
<td>5021339</td>
<td>5021339</td>
</tr>
<tr class="odd">
<td>11</td>
<td>5021340</td>
<td>5021340</td>
</tr>
<tr class="even">
<td>12</td>
<td>5021341</td>
<td>5021341</td>
</tr>
</tbody>
</table>
<h5 id="asignaturas-de-la-upo">Asignaturas de la UPO</h5>
<p>Empezamos creando las asignaturas de la UPO, en la instancia Moodle de dicha universidad (http://localhost:8080)</p>
<p>Accedemos a Site administration y, allí, abrimos la pestaña “Courses” y pulsamos “Add a new course”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Search.png" /></p>
<p>Creamos la primera asignatura: Modelos Predictivos II. En el Course ID Number, introducimos el código de la asignatura para la UPO</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Add%20a%20new%20course.png" /></p>
<p>Comprobamos que la asignatura se ha creado correctamente</p>
<p><img src="imagenes/Screenshot_2021-07-10%20MPII%20Participants.png" /></p>
<p>Pasamos a crear el resto de asignaturas</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Add%20a%20new%20course(1).png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Add%20a%20new%20course(2).png" /></p>
<h5 id="asignaturas-de-la-uca">Asignaturas de la UCA</h5>
<p>Seguimos con las asignaturas de la UCA, en http://localhost:8082</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Add%20a%20new%20course_uca.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Add%20a%20new%20course(1)_uca.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Add%20a%20new%20course(2)_uca.png" /></p>
<h4 id="instalando-auth_saml">Instalando auth_saml</h4>
<p>Creadas las asignaturas, pasamos a instalar el módulo <a href="https://moodle.org/plugins/auth_saml">auth_saml</a>. Este nos permitirá realizar la autenticación de usuarios de Moodle a través de SimpleSAML.</p>
<p>Lo descargamos de la <a href="https://moodle.org/plugins/auth_saml/versions">página de descargas</a> de la web oficial. En este caso, descargamos la última versión (auth/saml version of 16-07-2019 (2019071601)).</p>
<p>Hecho esto, entramos a Moodle, en Site administration y, en la pestaña plugins, pulsamos “add a new plugin”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Install%20plugins.png" /></p>
<p>Arrastramos el fichero ZIP a la sección ZIP Package, y pulsamos en “Install plugin from the ZIP file”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Install%20plugins(1).png" /></p>
<p>En la nueva página, pulsamos en “Continue”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Current%20release%20information.png" /></p>
<p>Nos aparecerá una página indicando que cumple los requisitos. Pulsamos el botón de la parte inferior</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Plugins%20check.png" /></p>
<p>Comenzará la instalación del plugin. Pulsamos en “Upgrade Moodle database now”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Upgrading%20to%20new%20version%20-%20Moodle%203%2011%20(Build%2020210517).png" /></p>
<p>Nos aparecerá un mensaje indicando que la instalación ha sido exitosa</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20New%20settings.png" /></p>
<p>Vemos un formulario donde se nos indican los datos de configuración del plugin. Los modificamos acorde a nuestra instalación, y pulsamos el botón al final de la página</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Authentication%20SAML%20Authentication(3).png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Authentication%20Manage%20authentication3.png" /></p>
<p>Volveremos a la página principal de Moodle</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Notifications.png" /></p>
<h5 id="activando-el-módulo">Activando el módulo</h5>
<p>Volvemos a Site Administration y, en la pestaña plugins, navegamos hasta la sección “Administration”, y pulsamos sobre ella</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Search1.png" /></p>
<p>Nos llevará a una página con el listado de plugins de autenticación. Buscamos “SAML Authentication”, y pulsamos en el botón del “ojo” en la misma</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Authentication.png" /></p>
<p>Vemos como el módulo se activa correctamente</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Authentication%20Manage%20authentication.png" /></p>
<p>Pulsamos en “Save changes” al final de la página</p>
<p>Repetimos el proceso con la otra universidad</p>
<h4 id="instalando-enrol_saml">Instalando enrol_saml</h4>
<p>Repetimos el proceso anterior con el plugin enrol_saml. Descargamos el plugin de la <a href="https://moodle.org/plugins/enrol_saml/versions">pagina oficial</a>, y lo cargamos en Moodle</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Install%20plugins(1)7.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20Plugins%20check6.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20Upgrading%20to%20new%20version%20-%20Moodle%203%2011%20(Build%2020210517)5.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20New%20settings4.png" /></p>
<p>Esta vez, para activarlo, en la pestaña de Plugins, navegamos a la sección Enrolments</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Search3.png" /></p>
<p>Y lo activamos de forma similar a la anterior</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Plugins%20Enrolments%20Manage%20enrol%20plugins.png" /></p>
<p>Repetimos el proceso en la otra universidad</p>
<h4 id="registrando-alumnos">Registrando alumnos</h4>
<p>Con los plugins de SAML ya creados, pasamos a registrar algunos alumnos utilizando SAML como autenticación.</p>
<h5 id="registrando-usuarios-en-la-base-de-datos">Registrando usuarios en la base de datos</h5>
<p>Para poder sincronizar los alumnos con SImpleSAML, es necesario que estos estén ya registrados en la base de datos de la universidad.</p>
<p>Para ello, accedemos a dicha base de datos, y los añadimos. En la UCA ya lo añadimos anteriormente, así que repetiremos el proceso con la UPO</p>
<pre><code>almu@debian:~/Practicas_IN/Practica2/uca$ sudo docker exec -it upo_mariadb_upo_1 mysql -u &#39;upousr&#39; -p
[sudo] password for almu: 
Enter password: 
Welcome to the MariaDB monitor.  Commands end with ; or \g.
Your MariaDB connection id is 183
Server version: 10.5.11-MariaDB Source distribution

Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.

Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.

MariaDB [(none)]&gt; use upo;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
MariaDB [upo]&gt; INSERT INTO upo.alumnos(identificador, nombre, ape1, ape2, password, dni, correo)
    -&gt;         VALUES(&#39;sara.marquez&#39;, &#39;Sara&#39;, &#39;Marquez&#39;, &#39;Lopez&#39;, &#39;user3&#39;, &#39;12563108J&#39;, &#39;sara.marquez@upo.es&#39;);
Query OK, 1 row affected (0.006 sec)

MariaDB [upo]&gt; INSERT INTO upo.alumnos(identificador, nombre, ape1, ape2, password, dni, correo)
    -&gt;         VALUES(&#39;marta.santos&#39;, &#39;Marta&#39;, &#39;Santos&#39;, &#39;Garcia&#39;, &#39;user4&#39;, &#39;10437984H&#39;, &#39;marta.santos@upo.es&#39;);
Query OK, 1 row affected (0.005 sec)

MariaDB [upo]&gt; INSERT INTO upo.matriculados(id_alumno, status) VALUES (1, &#39;a&#39;);
ERROR 1054 (42S22): Unknown column &#39;status&#39; in &#39;field list&#39;
MariaDB [upo]&gt; INSERT INTO upo.matriculados(id_alumno, enabled) VALUES (1, 1);
Query OK, 1 row affected (0.007 sec)

MariaDB [upo]&gt; INSERT INTO upo.matriculados(id_alumno, enabled) VALUES (2, 1);
Query OK, 1 row affected (0.006 sec)

MariaDB [upo]&gt; INSERT INTO upo.asignaturas(acod, cod) VALUES(&#39;5021336&#39;, &#39;5021336&#39;);
Query OK, 1 row affected (0.005 sec)

MariaDB [upo]&gt; INSERT INTO upo.asignaturas(acod, cod) VALUES(&#39;5021337&#39;, &#39;5021337&#39;);
Query OK, 1 row affected (0.005 sec)

MariaDB [upo]&gt; INSERT INTO upo.asignaturas(acod, cod) VALUES(&#39;5021338&#39;, &#39;5021338&#39;);
Query OK, 1 row affected (0.005 sec)</code></pre>
<h5 id="registrando-los-usuarios-en-moodle">Registrando los usuarios en Moodle</h5>
<p>Añadidos los usuarios a la base de datos, los registramos en Moodle.</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Search7.png" /></p>
<p>En Site Administration, en la pestaña Users, pulsamos “Add a new user”</p>
<p><img src="imagenes/Screenshot_2021-07-10%20New%20Site%20Administration%20Users%20Accounts%20Add%20a%20new%20user.png" /></p>
<p>Rellenamos los datos del usuario, indicando en “Choose an authentication method” SAML Authentication</p>
<p><img src="imagenes/Screenshot_2021-07-10%20Dashboard3.png" /></p>
<h4 id="matriculando-a-los-usuarios-en-asignaturas">Matriculando a los usuarios en asignaturas</h4>
<p>Por cada asignatura, pulsamos en “Participants” y añadimos a los usuarios que hemos registrado</p>
<p><img src="imagenes/Screenshot_2021-07-11%20MP-II%20Participants.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-11%20MD-II%20Participants.png" /></p>
<p><img src="imagenes/Screenshot_2021-07-11%20ID%20Participants.png" /></p>
<p>Repetimos el proceso en la otra universidad</p>
<h3 id="generando-imágenes-de-la-infraestructura">Generando imágenes de la infraestructura</h3>
<p>Generamos imágenes con el estado de la infraestructura hasta el momento:</p>
<ul>
<li><p>Base de datos UPO: <a href="https://hub.docker.com/repository/docker/almuhs/mariadb_upo">almuhs/mariadb_upo:v2</a></p></li>
<li><p>Base de datos UCA: <a href="https://hub.docker.com/repository/docker/almuhs/mariadb_uca">almuhs/mariadb_uca:v2</a></p></li>
<li><p>SimpleSAML UPO: <a href="https://hub.docker.com/repository/docker/almuhs/simplesamlphp_upo">almuhs/simplesamlphp_upo:v1</a></p></li>
<li><p>SimpleSAML UCA: <a href="https://hub.docker.com/repository/docker/almuhs/simplesamlphp_uca">almuhs/simplesamlphp_uca:v1</a></p></li>
<li><p>Imagen mixta SimpleSAML+Moodle UPO: <a href="https://hub.docker.com/repository/docker/almuhs/simplesamlphp_moodle_upo">almuhs/simplesamlphp_moodle_upo</a></p>
<ul>
<li>Clave Admin: adminMoodle123+</li>
</ul></li>
</ul>
<p>Actualizamos los ficheros Docker Compose para generar los contenedores desde estas imágenes</p>
</body>
</html>
